using TrivyOperator.Dashboard.Application.Models;
using TrivyOperator.Dashboard.Application.Services.Abstractions;
using TrivyOperator.Dashboard.Domain.Trivy.ClusterVulnerabilityReport;
using TrivyOperator.Dashboard.Infrastructure.Abstractions;

namespace TrivyOperator.Dashboard.Application.Services;

public class ClusterVulnerabilityReportService(IConcurrentCache<string, IList<ClusterVulnerabilityReportCr>> cache)
    : IClusterVulnerabilityReportService
{
    public Task<IList<ClusterVulnerabilityReportDto>> GetClusterVulnerabilityReportDtos()
    {
        List<ClusterVulnerabilityReportDto> result = cache.SelectMany(kvp => kvp.Value)
            .Select(cr => cr.ToClusterVulnerabilityReportDto())
            .ToList();

        return Task.FromResult<IList<ClusterVulnerabilityReportDto>>(result);
    }

    public Task<IList<ClusterVulnerabilityReportDenormalizedDto>> GetClusterVulnerabilityReportDenormalizedDtos()
    {
        List<ClusterVulnerabilityReportDenormalizedDto> result = cache.SelectMany(kvp => kvp.Value)
            .SelectMany(cr => cr.ToClusterVulnerabilityReportDenormalizedDtos())
            .ToList();

        return Task.FromResult<IList<ClusterVulnerabilityReportDenormalizedDto>>(result);
    }
}
